<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesture Engine Tester v99</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #000;
            color: #e5e5e5;
            touch-action: none; /* Critical for gesture handling */
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        #touch-zone {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 300px;
            z-index: 10;
            cursor: crosshair;
        }
        #hud-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 300px;
            z-index: 5;
            pointer-events: none;
        }
        #console-area {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 300px;
            background: #111;
            border-top: 1px solid #333;
            z-index: 20;
            display: flex;
            flex-direction: column;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 4px 8px;
            border-bottom: 1px solid #222;
        }
        .log-entry.gesture { color: #4ade80; }
        .log-entry.continuous { color: #60a5fa; }
        .log-entry.spatial { color: #facc15; }
        
        .marker {
            position: absolute;
            width: 10px; height: 10px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <div class="fixed top-0 left-0 right-0 p-2 bg-black/80 backdrop-blur z-50 flex justify-between items-center border-b border-gray-800">
        <h1 class="font-bold text-sm text-gray-400">Gesture Engine v99</h1>
        <div class="flex gap-2 text-xs">
            <div>
                <label>Tap (ms)</label>
                <input type="range" id="param-tap" min="100" max="800" step="50" value="300" class="w-20">
                <span id="val-tap" class="font-mono">300</span>
            </div>
            <div>
                <label>Dist (px)</label>
                <input type="range" id="param-dist" min="10" max="100" step="5" value="30" class="w-20">
                <span id="val-dist" class="font-mono">30</span>
            </div>
        </div>
    </div>

    <canvas id="hud-layer"></canvas>

    <div id="touch-zone">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20">
            <div class="text-center">
                <p class="text-4xl font-bold">TOUCH AREA</p>
                <p class="text-sm mt-2">Perform Swipes, Taps, Zigzags, Pinches</p>
            </div>
        </div>
    </div>

    <div id="console-area">
        <div class="p-2 bg-gray-900 border-b border-gray-800 flex justify-between items-center">
            <span class="font-bold text-xs uppercase text-gray-500">Event Log</span>
            <button id="btn-clear" class="text-xs bg-gray-700 px-2 py-1 rounded hover:bg-gray-600">Clear</button>
        </div>
        <div id="log-content" class="flex-grow overflow-y-auto p-2 bg-black font-mono text-xs">
            </div>
        <div id="status-bar" class="p-2 bg-gray-800 text-xs font-bold text-white flex justify-between">
            <span id="status-fingers">Fingers: 0</span>
            <span id="status-continuous">State: Idle</span>
        </div>
    </div>

    <script type="module">
        import { GestureEngine } from './gestures.js';

        // --- DOM Elements ---
        const touchZone = document.getElementById('touch-zone');
        const canvas = document.getElementById('hud-layer');
        const ctx = canvas.getContext('2d');
        const logContainer = document.getElementById('log-content');
        const btnClear = document.getElementById('btn-clear');
        const statFingers = document.getElementById('status-fingers');
        const statState = document.getElementById('status-continuous');
        
        // --- Canvas Sizing ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 300; // Subtract console height
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Logging Helper ---
        function log(msg, type = 'normal') {
            const el = document.createElement('div');
            el.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString().split(' ')[0];
            el.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;
            logContainer.prepend(el);
            if(logContainer.children.length > 50) logContainer.lastChild.remove();
        }

        btnClear.onclick = () => logContainer.innerHTML = '';

        // --- Trail Visualizer ---
        let activePaths = {}; // pointerId -> array of points

        function drawPaths() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            Object.keys(activePaths).forEach(pid => {
                const pts = activePaths[pid];
                if(pts.length < 2) return;

                ctx.beginPath();
                ctx.moveTo(pts[0].x, pts[0].y);
                for(let i=1; i<pts.length; i++) {
                    ctx.lineTo(pts[i].x, pts[i].y);
                }
                
                // Color based on finger index (roughly)
                const colors = ['#4ade80', '#60a5fa', '#f87171', '#facc15'];
                ctx.strokeStyle = colors[pid % colors.length];
                ctx.stroke();
            });
            requestAnimationFrame(drawPaths);
        }
        drawPaths();

        // --- Initialize Engine ---
        const config = {
            tapDelay: 300,
            swipeThreshold: 30,
            debug: true
        };

        const engine = new GestureEngine(touchZone, config, {
            onGesture: (data) => {
                console.log("Gesture Detected:", data);
                
                let details = "";
                if (data.meta) {
                    // Extract interesting meta data for display
                    const parts = [];
                    if(data.meta.dir) parts.push(`Dir: ${data.meta.dir}`);
                    if(data.meta.align) parts.push(`Align: ${data.meta.align}`); // Test Vertical/Diagonal
                    if(data.meta.winding) parts.push(`Wind: ${data.meta.winding}`); // Test CW/CCW
                    if(data.meta.subMode) parts.push(`Sub: ${data.meta.subMode}`);
                    details = parts.length ? `(${parts.join(', ')})` : "";
                }

                // Flash the screen slightly for spatial tap detection
                if(data.id.includes('spatial')) {
                    log(`ðŸŽ¯ <b>${data.name.toUpperCase()}</b> ${details}`, 'spatial');
                } else {
                    log(`âœ¨ <b>${data.name.toUpperCase()}</b> ${details}`, 'gesture');
                }
            },
            onContinuous: (data) => {
                statState.textContent = `State: ${data.type.toUpperCase()}`;
                
                let val = "";
                if(data.type === 'pinch') val = `Scale: ${data.scale.toFixed(2)}`;
                if(data.type === 'twist') val = `Val: ${data.value}`;
                if(data.type === 'squiggle') val = `Fingers: ${data.fingers}`;

                log(`ðŸŒŠ Continuous: ${data.type} [${val}]`, 'continuous');
            }
        });

        // --- Settings Controls ---
        const pTap = document.getElementById('param-tap');
        const vTap = document.getElementById('val-tap');
        const pDist = document.getElementById('param-dist');
        const vDist = document.getElementById('val-dist');

        pTap.oninput = (e) => {
            config.tapDelay = parseInt(e.target.value);
            vTap.textContent = config.tapDelay;
            engine.config.tapDelay = config.tapDelay; // Direct update
        };

        pDist.oninput = (e) => {
            config.swipeThreshold = parseInt(e.target.value);
            vDist.textContent = config.swipeThreshold;
            engine.config.swipeThreshold = config.swipeThreshold; // Direct update
        };

        // --- Raw Input Tracking for Visuals ---
        // The engine handles logic, we handle visuals here
        touchZone.addEventListener('pointerdown', (e) => {
            activePaths[e.pointerId] = [{x: e.clientX, y: e.clientY}];
            statFingers.textContent = `Fingers: ${Object.keys(activePaths).length}`;
            touchZone.setPointerCapture(e.pointerId);
        });

        touchZone.addEventListener('pointermove', (e) => {
            if(activePaths[e.pointerId]) {
                activePaths[e.pointerId].push({x: e.clientX, y: e.clientY});
            }
        });

        const endPointer = (e) => {
            delete activePaths[e.pointerId];
            statFingers.textContent = `Fingers: ${Object.keys(activePaths).length}`;
            if(Object.keys(activePaths).length === 0) statState.textContent = "State: Idle";
        };

        touchZone.addEventListener('pointerup', endPointer);
        touchZone.addEventListener('pointercancel', endPointer);

        // --- Inject constraints ---
        // We want to test EVERYTHING, so we pass a massive list of allowed gestures
        // This simulates the engine being in a state where it accepts all complex shapes
        const allPossibleGestures = [
            'tap', 'double_tap', 'triple_tap', 'long_tap',
            'tap_2f_any', 'tap_2f_vertical', 'tap_2f_horizontal', 'tap_2f_diagonal_se', 'tap_2f_diagonal_sw',
            'double_tap_2f_any', 'triple_tap_2f_any', 
            'swipe_any', 'swipe_up', 'swipe_down', 'swipe_left', 'swipe_right', 'swipe_nw', 'swipe_ne', 'swipe_sw', 'swipe_se',
            'zigzag_any', 'zigzag_right', 'zigzag_left', 'long_zigzag_any',
            'boomerang_any', 'boomerang_left', 'boomerang_right',
            'motion_tap_spatial_any', 'motion_tap_spatial_up', 'motion_tap_spatial_down', 'motion_tap_spatial_left', 'motion_tap_spatial_right',
            'triple_tap_spatial_line_any', 'triple_tap_spatial_corner_ne', 'triple_tap_spatial_corner_nw'
        ];
        
        // Use the public method to update allowed constraints
        engine.updateAllowed(allPossibleGestures);

        log("Engine v99 Ready. Constraints loaded.", 'normal');

    </script>
</body>
    </html>
    
