<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Tracking Test</title>
    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #video-container {
            position: relative;
            width: 100%;
            max-width: 480px;
            aspect-ratio: 3/4;
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            background: #111;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect for selfie cam */
        }

        #overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            pointer-events: none;
        }

        #gesture-result {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        #status {
            margin-top: 10px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        button {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 1rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
        <div id="overlay">
            <div style="font-size: 0.8rem; text-transform: uppercase;">Detected Count</div>
            <div id="gesture-result">-</div>
        </div>
    </div>

    <p id="status">Initializing AI...</p>
    <button id="enableWebcamButton" disabled>ENABLE WEBCAM</button>

    <script type="module">
        import {
            FilesetResolver,
            HandLandmarker
        } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        const video = document.getElementById("webcam");
        const enableWebcamButton = document.getElementById("enableWebcamButton");
        const statusText = document.getElementById("status");
        const resultText = document.getElementById("gesture-result");
        let handLandmarker = undefined;
        let lastVideoTime = -1;
        let results = undefined;

        // 1. Initialize the AI Model
        const createHandLandmarker = async () => {
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
                );
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });
                statusText.innerText = "AI Loaded. Ready to start.";
                enableWebcamButton.disabled = false;
            } catch (error) {
                statusText.innerText = "Error loading AI: " + error.message;
                console.error(error);
            }
        };

        createHandLandmarker();

        // 2. Enable Webcam
        const enableCam = async () => {
            if (!handLandmarker) {
                console.log("Wait! objectDetector not loaded yet.");
                return;
            }

            enableWebcamButton.style.display = "none";
            statusText.innerText = "Starting Camera...";

            const constraints = {
                video: {
                    facingMode: "user", // "user" = Front Camera
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                statusText.innerText = "Tracking Hand...";
            } catch (err) {
                statusText.innerText = "Camera Error: " + err.message;
            }
        };

        enableWebcamButton.addEventListener("click", enableCam);

        // 3. Prediction Loop
        async function predictWebcam() {
            let startTimeMs = performance.now();
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                results = handLandmarker.detectForVideo(video, startTimeMs);
            }

            if (results && results.landmarks.length > 0) {
                const landmarks = results.landmarks[0];
                const count = countFingers(landmarks);
                resultText.innerText = count;
            } else {
                resultText.innerText = "-";
            }

            window.requestAnimationFrame(predictWebcam);
        }

        // 4. The Math (Simple Logic)
        function countFingers(landmarks) {
            // Finger Tips Indices: 4 (Thumb), 8 (Index), 12 (Middle), 16 (Ring), 20 (Pinky)
            // Finger PIP/Knuckle Indices: 3, 6, 10, 14, 18
            
            let count = 0;

            // Check Index (8), Middle (12), Ring (16), Pinky (20)
            // Logic: Is the Tip (y) HIGHER (smaller value) than the Joint (y)?
            // Note: In video coordinates, Y=0 is the top.
            if (landmarks[8].y < landmarks[6].y) count++;
            if (landmarks[12].y < landmarks[10].y) count++;
            if (landmarks[16].y < landmarks[14].y) count++;
            if (landmarks[20].y < landmarks[18].y) count++;

            // Thumb (4) is tricky. We usually check X axis relative to knuckle (3).
            // Depending on left/right hand, the math flips.
            // Simplified "Up" check for thumb:
            if (landmarks[4].y < landmarks[3].y) count++;

            return count;
        }
    </script>
</body>
</html>
