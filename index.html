<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clean Gesture Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: #000; 
            color: #fff; 
            overflow: hidden; 
            touch-action: none; 
            user-select: none;
            font-family: 'Inter', sans-serif;
        }
        
        /* The Ghost UI Layer - Clicks pass through this */
        #ghost-ui {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* KEY: This lets you swipe through text */
            z-index: 10;
        }

        #trail-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none; /* Let clicks pass */
            z-index: 20;
        }

        /* Buttons need pointer events back */
        .interactive-btn {
            pointer-events: auto;
            cursor: pointer;
        }

        /* Animations */
        @keyframes flashGreen { 0% { background: rgba(0,255,0,0.5); } 100% { background: transparent; } }
        @keyframes flashRed { 0% { background: rgba(255,0,0,0.5); } 100% { background: transparent; } }
        .flash-pass { animation: flashGreen 0.3s ease-out; }
        .flash-fail { animation: flashRed 0.3s ease-out; }
    </style>
</head>
<body id="app-body">

    <canvas id="trail-canvas"></canvas>

    <div class="status-bar">
        <div class="text-xs text-gray-500 font-mono">
            TEST: <span id="progress-display">0/0</span>
        </div>
        <button id="end-early-btn" class="interactive-btn bg-red-900/50 hover:bg-red-700 text-white text-[10px] px-2 py-1 rounded border border-red-800">
            FINISH & REPORT
        </button>
    </div>

    <div id="ghost-ui">
        <div id="instruction-label" class="text-gray-600 text-sm uppercase tracking-[0.2em] mb-2">PERFORM</div>
        <div id="gesture-name" class="text-5xl md:text-7xl font-black text-white/20 text-center px-4 leading-tight transition-all duration-200">
            LOADING...
        </div>
        <div id="feedback-sub" class="mt-4 text-xl font-mono text-yellow-500/80 h-6">Attempt 1/3</div>
        <div id="last-detected" class="mt-2 text-xs font-mono text-gray-600 h-4"></div>
    </div>

    <div id="report-modal" class="fixed inset-0 bg-black z-50 hidden flex flex-col p-6">
        <h1 class="text-2xl font-bold text-green-500 mb-2">DIAGNOSTIC REPORT</h1>
        <p class="text-gray-400 text-xs mb-4">Copy this and give it to the developer.</p>
        <textarea id="report-output" class="flex-grow bg-gray-900 border border-gray-700 text-green-400 font-mono text-xs p-4 rounded resize-none mb-4 outline-none"></textarea>
        <div class="flex gap-2 h-12">
            <button id="copy-btn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded interactive-btn">COPY</button>
            <button onclick="location.reload()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded interactive-btn">RESTART</button>
        </div>
    </div>

    <script type="module">
        import { GestureEngine } from './gestures.js';

        // --- THE FULL LIST ---
        const TEST_QUEUE = [
            // Basics
            'tap', 'double_tap', 'triple_tap', 'long_tap',

            // Spatial Taps
            'motion_tap_spatial_any', 
            'motion_tap_spatial_up', 'motion_tap_spatial_down', 'motion_tap_spatial_left', 'motion_tap_spatial_right',
            
            // 3-Tap Lines
            'triple_tap_spatial_line_up', 'triple_tap_spatial_line_down', 'triple_tap_spatial_line_left', 'triple_tap_spatial_line_right',

            // Corners
            'triple_tap_spatial_corner_ne', 'triple_tap_spatial_corner_nw', 'triple_tap_spatial_corner_se', 'triple_tap_spatial_corner_sw',

            // Multi-Touch
            'tap_2f_any', 'double_tap_2f_any', 'triple_tap_2f_any',
            'tap_3f_any', 'double_tap_3f_any', 'triple_tap_3f_any',

            // Swipes
            'swipe_up', 'swipe_down', 'swipe_left', 'swipe_right',
            'swipe_long_up', 'swipe_long_down', 'swipe_long_left', 'swipe_long_right',

            // Multi-Swipes
            'swipe_up_2f', 'swipe_down_2f', 'swipe_left_2f', 'swipe_right_2f',
            'pinch_swipe_any_2f', 'expand_swipe_any_2f',

            // Shapes
            'boomerang_up', 'boomerang_down', 'boomerang_left', 'boomerang_right',
            'zigzag_up', 'zigzag_down', 'zigzag_left', 'zigzag_right',
            
            // Complex
            'square_cw', 'square_ccw',
            'triangle_cw', 'triangle_ccw'
        ];

        // --- STATE ---
        let currentIndex = 0;
        let attempts = 1;
        let results = [];
        let engine;
        let trailCtx;
        let fadeTimer;

        // --- DOM ---
        const els = {
            body: document.getElementById('app-body'),
            name: document.getElementById('gesture-name'),
            sub: document.getElementById('feedback-sub'),
            detected: document.getElementById('last-detected'),
            progress: document.getElementById('progress-display'),
            canvas: document.getElementById('trail-canvas'),
            modal: document.getElementById('report-modal'),
            report: document.getElementById('report-output'),
            copyBtn: document.getElementById('copy-btn'),
            endBtn: document.getElementById('end-early-btn')
        };

        // --- INIT ---
        function init() {
            // 1. Setup Canvas
            els.canvas.width = window.innerWidth;
            els.canvas.height = window.innerHeight;
            trailCtx = els.canvas.getContext('2d');

            // 2. Setup Engine
            engine = new GestureEngine(document.body, {
                debug: true,
                tapDelay: 300,
                swipeThreshold: 30
            }, {
                onGesture: (d) => checkGesture(d),
                onContinuous: (d) => { /* Ignore continuous for specific tests unless needed */ },
                onDebug: (msg) => console.log(msg)
            });

            // 3. Unblock all gestures
            engine.updateAllowed(TEST_QUEUE);

            // 4. Start Test
            loadNext();

            // 5. Drawing Listeners
            document.body.addEventListener('pointermove', drawTrail);
            document.body.addEventListener('pointerdown', startTrail);
        }

        // --- LOGIC ---
        function loadNext() {
            if (currentIndex >= TEST_QUEUE.length) {
                finish();
                return;
            }

            const target = TEST_QUEUE[currentIndex];
            els.name.textContent = target.replace(/_/g, ' ').replace('spatial', '').trim();
            els.name.style.color = 'rgba(255,255,255,0.2)'; // Reset color
            
            attempts = 1;
            updateStatus();
            els.detected.textContent = "";
            els.progress.textContent = `${currentIndex + 1}/${TEST_QUEUE.length}`;
        }

        function updateStatus() {
            els.sub.textContent = `Attempt ${attempts}/3`;
            els.sub.style.color = attempts === 1 ? '#4ade80' : (attempts === 2 ? '#facc15' : '#f87171');
        }

        function checkGesture(data) {
            if (currentIndex >= TEST_QUEUE.length) return;

            const target = TEST_QUEUE[currentIndex];
            const detectedID = data.id;

            let isMatch = false;

            // 1. Exact
            if (detectedID === target) isMatch = true;

            // 2. Wildcards (e.g. target="swipe_any", detected="swipe_up" -> PASS)
            if (!isMatch && target.endsWith('_any')) {
                const base = target.replace('_any', '');
                if (detectedID.startsWith(base)) isMatch = true;
            }

            // 3. Relaxed Long Swipes (target="swipe_up", detected="swipe_long_up" -> PASS)
            if (!isMatch && detectedID.includes('long') && !target.includes('long')) {
                if (detectedID.replace('long_', '') === target) isMatch = true;
            }

            els.detected.textContent = `Saw: ${detectedID}`;

            if (isMatch) {
                // Success
                flash('flash-pass');
                results.push({ target, status: 'PASS', attempts, detected: detectedID });
                
                // Visual feedback before moving on
                els.name.style.color = '#4ade80'; // Green text
                els.name.textContent = "YES";
                
                setTimeout(() => {
                    currentIndex++;
                    loadNext();
                }, 400);

            } else {
                // Fail
                flash('flash-fail');
                
                if (attempts >= 3) {
                    results.push({ target, status: 'FAIL', attempts, detected: detectedID });
                    
                    els.name.style.color = '#f87171'; // Red text
                    els.name.textContent = "SKIP";
                    
                    setTimeout(() => {
                        currentIndex++;
                        loadNext();
                    }, 400);
                } else {
                    attempts++;
                    updateStatus();
                }
            }
        }

        function flash(className) {
            els.body.classList.remove('flash-pass', 'flash-fail');
            void els.body.offsetWidth; // Trigger reflow
            els.body.classList.add(className);
        }

        function finish() {
            els.modal.classList.remove('hidden');
            
            const passed = results.filter(r => r.status === 'PASS');
            const failed = results.filter(r => r.status === 'FAIL');

            let txt = `GESTURE REPORT (${Math.round((passed.length / results.length)*100)}% Success)\n`;
            txt += "----------------------------------------\n";
            
            if(failed.length > 0) {
                txt += "FAILED ITEMS:\n";
                failed.forEach(f => {
                    txt += `[X] ${f.target} (Last saw: ${f.detected || 'none'})\n`;
                });
                txt += "\n";
            }

            txt += "PASSED ITEMS:\n";
            passed.forEach(p => {
                txt += `[O] ${p.target} (${p.attempts} tries)\n`;
            });

            els.report.value = txt;
        }

        // --- CANVAS TRAIL ---
        function startTrail() {
            trailCtx.clearRect(0, 0, els.canvas.width, els.canvas.height);
            clearTimeout(fadeTimer);
        }

        function drawTrail(e) {
            if (e.buttons === 0) return;
            trailCtx.lineWidth = 4;
            trailCtx.lineCap = 'round';
            trailCtx.strokeStyle = 'rgba(74, 222, 128, 0.6)';
            trailCtx.lineTo(e.clientX, e.clientY);
            trailCtx.stroke();
            trailCtx.beginPath();
            trailCtx.moveTo(e.clientX, e.clientY);
            
            // Auto fade
            clearTimeout(fadeTimer);
            fadeTimer = setTimeout(() => {
                trailCtx.clearRect(0, 0, els.canvas.width, els.canvas.height);
            }, 800);
        }

        // --- BUTTONS ---
        els.copyBtn.onclick = () => {
            els.report.select();
            navigator.clipboard.writeText(els.report.value);
            els.copyBtn.textContent = "COPIED!";
        };
        els.endBtn.onclick = finish;

        // Start
        init();

    </script>
</body>
</html>
